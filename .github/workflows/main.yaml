name: sahas_ui PROD Deployment

on:
    push:
        branches:
            - main
    schedule:
        - cron: "30 18 * * *"

env:
    DEPLOYMENT_DIRECTORY: "/var/www/sites/prod.sahasinstitute.com/"
    REPO: "sahas_ui"
    BRANCH: "main"

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Preparing SSH
              run: sudo apt-get install -y sshpass

            - name: SSH Deployment
              run: |
                  sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no "${{ secrets.SSH_USERNAME }}@${{ secrets.HOSTING_SERVER }}" << 'EOF'
                    set -e
                    
                    cd "${{ env.DEPLOYMENT_DIRECTORY }}"
                    if [ -d "${{ env.REPO }}" ]; then
                      cd "${{ env.REPO }}"
                      pid=$(cat process.id)
                      if ps -p $pid > /dev/null; then
                        echo "Terminating ${{ env.REPO }} - pid $pid"
                        kill -9 $pid
                      fi
                      git stash
                      git checkout "${{env.BRANCH}}"
                      git fetch origin "${{env.BRANCH}}"
                      git pull origin "${{env.BRANCH}}" --rebase
                    else
                      echo "Fetching Source - ${{ env.REPO }}"
                      git clone --branch "${{env.BRANCH}}" https://github.com/rocketstriker999/${{ env.REPO }}
                      cd "${{ env.REPO }}"
                    fi

                    echo "Installing dependencies..."
                    npm install
                    rm -rf build
                    npm run build
                    serve -s build -l 3000 > /dev/null 2>&1 &
                    new_pid=$!
                    echo "Starting ${{ env.REPO }} - pid $new_pid"
                    echo $new_pid > process.id
                    echo "âœ… Deployed & Disconnecting SSH"
                    exit 0
                  EOF
